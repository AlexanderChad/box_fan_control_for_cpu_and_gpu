# box_fan_control_for_cpu_and_gpu

Проект представляет собой реализацию простого сервиса для автоматического управления кулерами на материнской плате.  
Умеет определять количество CPU и GPU. Выбирает самый горячий процессор из каждого типа и устанавливает скорость на основе максимально нуждающегося в охлаждении. GPU поддерживаются только Nvidia (необходима утилита `nvidia-smi`).  
НЕ управляет оборотами кулеров видеокарт (для безопасности), только читает температуру.  
Тестировалось на плате `MACHINIST X99 D8 MAX` с двумя `Nvidia RTX 2080 Ti`, `Proxmox VE 8.2` и `8.4.1`.  

Проект состоит из двух компонентов:  
1. `fanc.sh` - скрипт управления на хосте (получает температуру `CPUs` и управляет кулерами корпуса)  
1. `fanc_server.py` - скрипт получения температуры `GPUs` (`fanc.sh` получает температуру видеокарт от него)  

## Как работает  
`fanc.sh` переводит в кулеры в управляемый режим, следит за температурой всех CPU и GPU.  
Считывает температуру со всех `CPU` и `GPU`, определяет наибольшую для каждого типа устройства.  
После рассчитывает необходимые обороты кулеров для каждого типа устройства и выбирает наибольшее.  
Таким образом `обороты всегда ориентируются на самое горячее устройство`.  
Для каждого типа устройства устанавливается диапазон температур для пересчета в обороты.  

Ранее температуру `GPU` скрипт получал сам. Сейчас же это делает `fanc_server.py`.  
Дело в том, что при использовании `vGPU и гибридного драйвера` и/или `проброса в контейнер` не было проблем с получением информации о температуре непосредственно с `хоста`.  
Но при прокидывании в `виртуальную машину` видеокарты целиком возникла проблема невозможности считывания температуры.  
Ко всему прочему системы различались (`Windows`/`Linux`), а температуру нужно было получать со всех, кому выдали карту.  
Потому часть чтения температуры была вынесена прямо в `ВМ`.  
Но при желании использовать в формате как было раньше достаточно просто запустить скрипт для ВМ на хосте, прописать `127.0.0.1:17006`. Конечно, будут некоторые накладные расходы, но они не большие. При желании можно использовать коммит до добавления `fanc_server.py`.  

## Установка и настройка на хосте  
1. Скачать и перейти в папку `box_fan_control_for_cpu_and_gpu`:
	```
	git clone https://github.com/AlexanderChad/box_fan_control_for_cpu_and_gpu.git
	cd box_fan_control_for_cpu_and_gpu
	```
1. Заменить в `fanc.service` путь до файла `fanc.sh` на свой, например:
	```
	- ExecStart=/home/fanc.sh
	+ ExecStart=/home/alex/box_fan_control_for_cpu_and_gpu/fanc.sh
	```
1. Убедиться в наличии и правильной работе утилит `sensors` и `nvidia-smi` (только в случае запуска `fanc_server.py` на хосте). При отсутствии или неправильной работе установить/обновить/настроить.  
1. В `fanc.sh` установить предпочитаемые настройки:  
	* `DELAY=2` - время между проверками  
	* `CPU_MIN_TEMP=50` - минимальная температура CPU, до этой температуры PWM сигнал будет минимальный (`FAN_MIN_SIGNAL`)  
	* `CPU_MAX_TEMP=60` - максимальная температура CPU, при ней и выше обороты будут максимальными  
	* `GPU_MIN_TEMP=55` - минимальная температура GPU, до этой температуры PWM сигнал будет минимальный (`FAN_MIN_SIGNAL`)  
	* `GPU_MAX_TEMP=70` - максимальная температура GPU, при ней и выше обороты будут максимальными  
	* `FAN_MIN_SIGNAL=75` - минимальный сигнал PWM (порог), при котором кулеры будут вращаться (ниже которого связь сигнал-обороты пропадает)  
	* `ANOMAL_MIN_TEMP=5` - минимальная температура, которую можно считать правдивой  
	* `ANOMAL_MAX_TEMP=90` - максимальная температура, которую можно считать правдивой.  
	
	Узнать `FAN_MIN_SIGNAL` можно с помощью `pwmconfig` из пакета `fancontrol` или подобрать экспериментально.  
	С помощью той же утилиты можно найти прямые пути до точек управления кулерами.  
	Необходимо будет исправить в `FAN_CTRL_PATH` путь на ваш, например:  
	```
	- FAN_CTRL_PATH='/sys/devices/platform/nct6775.2592/hwmon/[[:print:]]*'
	+ FAN_CTRL_PATH='/sys/devices/platform/coretemp.0/hwmon/[[:print:]]*'
	```  
1. Разрешить выполнение `fanc.sh`:  
	```
	chmod +x fanc.sh
	```  
1. Запустить `fanc.sh` и убедится в корректности работы:  
	```
	./fanc.sh
	```  
1. Зарегистрировать сервис, добавить в автозапуск, запустить и проверить статус:  
	```
	systemctl enable '/home/alex/box_fan_control_for_cpu_and_gpu/fanc.service'
	systemctl daemon-reload
	systemctl start fanc
	systemctl status fanc
	```  
	В статусе после удачного запуска должно быть:  
	```
		● fanc.service - Fan control
		Loaded: loaded (/etc/systemd/system/fanc.service; enabled; preset: enabled)
		Active: active (running) since Sun 2024-06-16 23:26:03 +07; 6s ago
		Main PID: 1469146 (fanc.sh)
		Tasks: 2 (limit: 154467)
		Memory: 5.5M
			CPU: 696ms
		CGroup: /system.slice/fanc.service
				├─1469146 /bin/bash /home/alex/box_fan_control_for_cpu_and_gpu/fanc.sh
				└─1469452 sleep 1
	
	Jun 16 23:26:03 aes systemd[1]: Started fanc.service - Fan control.
	Jun 16 23:26:03 aes fanc.sh[1469146]: CPU_SLOT_NUM = 2, GPU servers: 2
	Jun 16 23:26:03 aes fanc.sh[1469146]: Enable manual PWM control
	Jun 16 23:26:03 aes fanc.sh[1469146]: Start PWM control task
	```  
	Во время работы, при изменении оборотов кулеров, должны появляться следующие строчки:
	```
	Jun 16 23:34:05 aes fanc.sh[1469146]: gpu_max_temp_val = 53
	Jun 16 23:34:05 aes fanc.sh[1469146]: PWM: 87 -> 111
	Jun 16 23:34:06 aes fanc.sh[1469146]: 16/06/24 23:34:06 Checking temperatures...
	Jun 16 23:34:06 aes fanc.sh[1469146]: cpu_max_temp_val = 42
	Jun 16 23:34:06 aes fanc.sh[1469146]: gpu_max_temp_val = 54
	Jun 16 23:34:06 aes fanc.sh[1469146]: PWM: 111 -> 123
	Jun 16 23:34:07 aes fanc.sh[1469146]: 16/06/24 23:34:07 Checking temperatures...
	Jun 16 23:34:07 aes fanc.sh[1469146]: cpu_max_temp_val = 42
	Jun 16 23:34:07 aes fanc.sh[1469146]: gpu_max_temp_val = 55
	Jun 16 23:34:07 aes fanc.sh[1469146]: PWM: 123 -> 135
	```  

## Установка и настройка на ВМ  
Аналогично хосту установить сервис `fanc_vm.service` для linux.  
Или добавить в планировщик задач задание при загрузке системы запускать `fanc_server.py`.  
Для обоих предварительно нужно будет проверить наличие `python3` и установить пакет `nvidia-ml-py`.  

#### Пример развертывания на debian VM  
Пусть мы находимся в `/home/alex`.  
```
git clone https://github.com/AlexanderChad/box_fan_control_for_cpu_and_gpu.git
cd box_fan_control_for_cpu_and_gpu
python3 -m venv venv
./venv/bin/pip install nvidia-ml-py
```
Запускаем и добавляем в автозапуск аналогично хосту.  

## Демонстрация:  
[![Проверяю охлаждение сервера (ЦП и видеокарт)](https://i.ytimg.com/vi/YAdFYVp97Wk/hq720_2.jpg)](https://youtube.com/shorts/YAdFYVp97Wk?feature=share)  

### <b><font color="#FF0000">Предупреждение!</font></b>  
Неправильная работа сервиса может вызвать перегрев и выход из строя компонентов или системы в целом!  
Хоть код и имеет некоторую защиту:
* при возврате вместо температуры пустой строки считает температуру максимальной (и выводит обороты на максимум)  
* при получении температуры дополнительно проверяет на аномальные значения, т.е. на выход за пределы [`ANOMAL_MIN_TEMP`...`ANOMAL_MAX_TEMP`] (если функция возвращает число с невозможной температурой), при выходе считает температуру максимальной (и выводит обороты на максимум)  
* при нулевом количестве устройств (если получение информации завершилось ошибкой): с CPU - выводит сообщение `ERROR! No CPU devices found.` и выводит обороты на максимум до перезапуска сервиса, для GPU - в зависимости от серверов `fanc_server.py`  
* если не отвечает ни один `fanc_server.py`, то температура видеокарт считается минимальной, если отвечает, но на `ВМ` не может получить температуру - выводит обороты на максимум, т.е. все `ВМ` могут спать и скрипт будет работать только с `CPUs`, но при работе с `ВМ` требует корректного ответа  
* сервис имеет повышенный приоритет (политика FIFO, приоритет 98)  

но не учитывает других случаев, например:  
* неправильные настройки в файле `fanc.sh`   
* не установлены пакеты, содержащие `nvidia-smi` и `sensors` или они неправильно работают (не настроены)  
* во время выполнения команд получения температуры, чтения/установки PWM подпроцесс может заблокировать работу на неограниченное время  
* не следит за фактом проброса, чтобы выводить обороты, например, на 50% пока `fanc_server.py` не ответит из `ВМ`  
* получение информации от `fanc_server.py` ограничено 0.5 сек. Учитывая, что это ВМ и архитектуры `fanc_server.py` должно быть достаточно. Но получение выполняется последовательно. И каждая отключенная ВМ будет растягивать время обновления на 0.5 сек. Т.е. если в списке будет 6 `ВМ` и активных не будет, то реагировать на изменение температуры `CPUs` скрипт будет с частотой 1/(`DELAY=2` + 6*0.5), т.е. раз в 5 секунд.  
Да, добавить бы асинхронное получение, обновляя в файлах значение и читая каждые DELAY...  

А также некоторые другие. Возможно, в будущем я вернусь к этому и добавлю проверки, как это произошло спустя неделю, когда я дождался очередных выходных.  
Пока же это можете сделать вы или использовать как есть на свой страх и риск.  

### Совместимость  
Проверено на  `MACHINIST X99 D8 MAX` с двумя `Nvidia RTX 2080 Ti`, `Proxmox VE 8.2` и `8.4.1`, но должно работать после настройки и на других дистрибутивах / оборудовании.

[Заметка на Дзене](https://dzen.ru/a/Zm8bxGgDdF6HrKHd)  
